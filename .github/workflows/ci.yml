name: CI Pipeline (system/integration testing)

on:
  # We run CI on pushes to the main branch
  push:
    branches:
      - main
      - dev
  # and on all pull requests to the main branch
  pull_request:
    branches:
      - main
      - dev
  # as well as upon manual triggers through the 'Actions' tab of the Github UI
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        postgres_version: [ 14, 15, 16, 17 ] #14 is minimal required version
        redis_version: [ 6, 7, 8 ]

    env:
      POSTGRES_VERSION: ${{ matrix.postgres_version }}
      REDIS_VERSION: ${{ matrix.redis_version }}
      FRONTEND_BRANCH_NAME: ${{ github.ref_name }} #pull frontend from branch with the same name as backend is currently on

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install test requirements
      run: |
        python -m venv .venv
        source .venv/bin/activate
        python -m pip install -r tests/requirements.txt

    - name: Setup SSL certificates
      run: |
        mkdir -p ./backend-config/certs
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ./backend-config/certs/key.pem -out ./backend-config/certs/cert.pem -subj "/CN=localhost"

    - name: Setup docker compose
      run: |
        docker compose -f docker-compose.ci.yml up -d --build

    - name: Run test suite
      run: |
        source .venv/bin/activate
        pytest tests/
